# Tiptap Nodes Code Review Report

This report reviews the implementation of custom Tiptap nodes in `tiptap-editor/packages/tiptap-nodes/src/`, focusing on React best practices, data flow, SRP, and potential issues.

---

## 1. Speaker Node (`speaker/`)

### 维度 1 — SRP (单一职责原则)
- **分析**: `SpeakerNode` 承担了解析 (HTML/Markdown)、渲染 (Native NodeView) 和交互逻辑。逻辑被合理拆分到了 `resolveDisplayText` (纯函数) 和 `preprocessSpeakerTags` (转换逻辑) 中。
- **评价**: 🟢 **良好**。虽然 extension 文件较长，但符合 Tiptap 的插件化架构。

### 维度 2 — 数据流与状态管理
- **分析**: 使用 Tiptap Attributes 存储持久化数据。通过 `options.speakerMap` 实现外部配置驱动的标签映射，这是一种解耦的优秀实践。
- **评价**: 🟢 **优秀**。

### 维度 3 — i18n 处理
- **分析**: 在 `addNodeView` 中直接监听 `i18n.on('language:change')` 并手动更新 DOM。由于该 NodeView 不是 React 组件，这是确保 UI 与全局语言状态同步的正确方式。
- **推荐修复**: 🟡 **警告**。确保 `i18n` 实例在所有环境下（如 SSR）都能正确获取，代码中 `getI18nInstance()` 需要稳健的 fallback。

### 维度 4 — Markdown 解析
- **分析**: 提供了自定义的 `markdownTokenizer`，支持方括号 `[speaker:X]` 和 HTML 标签 `<speaker>X</speaker>` 两种格式。
- **评价**: 🟢 **良好**。

---

## 2. Image Upload Node (`image-upload/`)

### 维度 1 — React Hooks 规范
- **位置**: `hooks/use-file-upload.ts`
- **描述**: 
  - 使用了 `AbortController` 处理请求取消，避免了竞态条件和内存泄漏。
  - 正确调用 `URL.revokeObjectURL` 释放资源。
- **评价**: 🟢 **优秀**。

### 维度 2 — 逻辑与 UI 分离 (SRP)
- **分析**: 
  - `useFileUpload`: 封装纯业务逻辑（上传、进度、状态）。
  - `ImageUploadNode` (React 组件): 负责交互编排和 Tiptap 命令执行。
  - `ImageUploadNode` (Extension): 定义 Tiptap 节点元数据。
- **评价**: 🟢 **优秀**。

### 维度 3 — 潜在 Bug 与性能
- **位置**: `image-upload-node.tsx` 行 53-55
- **描述**: 上传完成后，使用 `deleteRange` 删除当前节点并插入图片。
- **严重度**: 🟡 **警告**
- **分析**: 在异步上传过程中，如果文档被大幅修改，`props.getPos()` 返回的位置是实时的，通常是安全的。但如果节点在上传过程中被用户手动删除，`isValidPosition(pos)` 的检查是必要的。目前的 `deleteRange` 逻辑依赖于 `pos` 依然指向当前的 `imageUpload` 节点。
- **建议**: 在执行 `deleteRange` 之前，可以再次验证 `editor.state.doc.nodeAt(pos)` 是否仍为 `imageUpload` 类型。

### 维度 4 — 交互体验
- **分析**: 提供了 `Enter` 快捷键触发上传，增强了无障碍性。
- **评价**: 🟢 **建议**。

---

## 3. Horizontal Rule (`horizontal-rule/`)

### 维度 1 — 扩展性
- **分析**: 继承自官方扩展，通过 `renderHTML` 包装了自定义的 `div` 容器。
- **评价**: 🟢 **简洁**。这样做方便了 Tailwind CSS 的样式挂载和 Prosemirror 的节点选择。

---

## 4. 总结与改进建议

### 整体质量: 🟢 **高**
代码结构清晰，充分利用了 Tiptap 的扩展机制，React 部分遵循了最佳实践（特别是 Hooks 的使用和异步处理）。

### 核心建议:
1. **类型安全**: `speaker/extension.ts` 中的 `resolvedDisplayText` 处理数字索引时（行 46-47），默认加 1 的逻辑具有较强的业务偏向，建议在代码注释中明确其业务背景。
2. **健壮性**: 在 `ImageUploadNode` 中，将上传后的节点替换操作包裹在一个 `try-catch` 或更严谨的节点校验逻辑中，防止在极端的编辑器并发编辑场景下出现内容错位。
3. **i18n**: 考虑将 `i18n` 的监听逻辑抽离成通用的 Prosemirror Plugin 辅助函数，减少 `SpeakerNode` 中的样板代码。

---
*Generated by Code Review Tooling*
